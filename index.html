<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>個人財富總管 App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react,react-dom",
        "recharts": "https://esm.sh/recharts@2.12.2?external=react,react-dom",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .safe-top { padding-top: env(safe-area-inset-top); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans antialiased selection:bg-indigo-100 touch-pan-y no-scrollbar">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Plus, Trash2, Save, TrendingUp, DollarSign, PieChart as PieIcon, History, LayoutDashboard, Cloud, CloudOff, RefreshCw, Calculator, Loader2, AlertTriangle, X, Check, ShieldCheck, User, LogIn, Key, Lock, ChevronRight, Wallet, CreditCard } from 'lucide-react';
        import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, Legend, ResponsiveContainer, AreaChart, Area, PieChart, Pie, Cell } from 'recharts';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'firebase/firestore';

        // =========================================================================
        // ★★★ Firebase 設定資訊 ★★★
        // =========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDLgXz2tDcl0SnurHau3ryQgbY9h2HS6Z4",
            authDomain: "wealth-management-22601.firebaseapp.com",
            projectId: "wealth-management-22601",
            storageBucket: "wealth-management-22601.firebasestorage.app",
            messagingSenderId: "775950696766",
            appId: "1:775950696766:web:5c447342be5b4632e6ec6f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const COLORS = ['#10b981', '#6366f1', '#f59e0b', '#ec4899', '#8b5cf6', '#14b8a6'];
        const CATEGORY_MAP = { 'invest': '股票/投資', 'cash': '現金/存款', 'real_estate': '房地產', 'mortgage': '房屋貸款', 'credit': '信用卡/信貸', 'loan': '其他借貸', 'other': '其他項目' };

        const WealthManager = () => {
          const [activeTab, setActiveTab] = useState('dashboard');
          const [assets, setAssets] = useState([]);
          const [liabilities, setLiabilities] = useState([]);
          const [records, setRecords] = useState([]);
          const [user, setUser] = useState(null);
          const [targetUid, setTargetUid] = useState(null);
          const [activeKey, setActiveKey] = useState(null); 
          const [loading, setLoading] = useState(true);
          const [syncStatus, setSyncStatus] = useState('idle'); 

          const [deleteModal, setDeleteModal] = useState({ isOpen: false, type: null, id: null, title: '' });
          const [accountModal, setAccountModal] = useState({ isOpen: false });
          const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
          const [inputKey, setInputKey] = useState(''); 
          const [authLoading, setAuthLoading] = useState(false);
          const isRemoteUpdate = useRef(false);

          const showToast = (message, type = 'success') => {
            setToast({ show: true, message, type });
            setTimeout(() => setToast({ show: false, message: '', type: 'success' }), 3000);
          };

          // 初始化登入
          useEffect(() => {
            const initAuth = async () => {
              try { await signInAnonymously(auth); } 
              catch (error) { setSyncStatus('error'); }
            };
            initAuth();
            const unsubscribe = onAuthStateChanged(auth, (u) => {
              setUser(u);
              if (u && !targetUid) setTargetUid(u.uid);
              if (!u) setLoading(false);
            });
            return () => unsubscribe();
          }, []);

          // 核心驗證邏輯 (單一密碼制)
          const handleAuth = async () => {
            if (!inputKey || inputKey.length < 4) { showToast('密碼請輸入至少 4 位數', 'error'); return; }
            setAuthLoading(true);
            try {
                const accountRef = doc(db, 'accounts', inputKey);
                const accountSnap = await getDoc(accountRef);
                
                if (accountSnap.exists()) {
                    // 已有密碼，讀取對應的 UID
                    const data = accountSnap.data();
                    setTargetUid(data.ownerUid);
                    setActiveKey(inputKey);
                    showToast(`同步成功，歡迎回來`);
                } else {
                    // 全新密碼，將目前的匿名 UID 綁定給這組密碼
                    await setDoc(accountRef, { 
                        ownerUid: user.uid, 
                        createdAt: new Date().toISOString() 
                    });
                    setTargetUid(user.uid);
                    setActiveKey(inputKey);
                    showToast(`新密碼已設定，資料已鎖定同步`);
                    // 確保目前的資料立即寫入雲端
                    forceSave(assets, liabilities, records, user.uid);
                }
                setAccountModal(false);
                setInputKey('');
            } catch (error) { showToast('驗證失敗，請檢查網路', 'error'); }
            setAuthLoading(false);
          };

          // 數據同步
          useEffect(() => {
            if (!targetUid) return;
            setLoading(true);
            const docRef = doc(db, 'users', targetUid);
            const unsubscribe = onSnapshot(docRef, (docSnap) => {
              if (docSnap.exists()) {
                const data = docSnap.data();
                isRemoteUpdate.current = true; 
                setAssets(data.assets || []);
                setLiabilities(data.liabilities || []);
                setRecords(data.records || []);
                setTimeout(() => { isRemoteUpdate.current = false; }, 800);
              } else {
                // 如果是全新空間，給予預設範例
                if (targetUid === user?.uid && !activeKey) {
                    setAssets([
                        { id: 1, name: '台股帳戶', amount: 0, category: 'invest', isForeign: false, foreignAmount: 0, exchangeRate: 1 },
                        { id: 2, name: '美股帳戶', amount: 0, category: 'invest', isForeign: true, foreignAmount: 0, exchangeRate: 32.5 }
                    ]);
                }
                isRemoteUpdate.current = false;
              }
              setLoading(false);
            }, (error) => { setSyncStatus('error'); setLoading(false); });
            return () => unsubscribe();
          }, [targetUid]);

          const forceSave = async (currAssets, currLiabs, currRecs, uid = targetUid) => {
            if (!uid) return;
            setSyncStatus('saving');
            try {
              const docRef = doc(db, 'users', uid);
              await setDoc(docRef, { assets: currAssets, liabilities: currLiabs, records: currRecs, lastUpdated: new Date().toISOString() }, { merge: true });
              setSyncStatus('saved');
              setTimeout(() => setSyncStatus('idle'), 3000);
            } catch (error) { setSyncStatus('error'); }
          };

          useEffect(() => {
            if (!targetUid || loading || isRemoteUpdate.current) return;
            const timer = setTimeout(() => { forceSave(assets, liabilities, records); }, 2000); 
            return () => clearTimeout(timer);
          }, [assets, liabilities, records, targetUid, loading]);

          const totalAssets = assets.reduce((sum, item) => sum + Number(item.amount), 0);
          const totalLiabilities = liabilities.reduce((sum, item) => sum + Number(item.amount), 0);
          const netWorth = totalAssets - totalLiabilities;

          const openDeleteModal = (type, id, title = '') => setDeleteModal({ isOpen: true, type, id, title });
          const confirmDelete = () => {
            const { type, id } = deleteModal;
            if (type === 'record') {
                const nr = records.filter(r => r.id !== id);
                setRecords(nr); forceSave(assets, liabilities, nr);
            } else if (type === 'asset') setAssets(prev => prev.filter(i => i.id !== id));
            else if (type === 'liability') setLiabilities(prev => prev.filter(i => i.id !== id));
            setDeleteModal({ isOpen: false, type: null, id: null, title: '' });
          };

          const handleAssetChange = (id, field, value) => {
            setAssets(prev => prev.map(item => {
              if (item.id !== id) return item;
              const updatedItem = { ...item, [field]: value };
              if (updatedItem.isForeign) {
                if (field === 'foreignAmount' || field === 'exchangeRate' || field === 'isForeign') {
                   const fAmount = field === 'foreignAmount' ? Number(value) : Number(updatedItem.foreignAmount);
                   const rate = field === 'exchangeRate' ? Number(value) : Number(updatedItem.exchangeRate);
                   updatedItem.amount = Math.round(fAmount * rate);
                }
              }
              if (field === 'amount' && !updatedItem.isForeign) updatedItem.amount = Number(value);
              return updatedItem;
            }));
          };

          const handleLiabilityChange = (id, value) => setLiabilities(prev => prev.map(i => i.id === id ? { ...i, amount: Number(value) } : i));
          const addItem = (type) => {
            const ni = { id: Date.now(), name: '新項目', amount: 0, category: 'other', isForeign: false, foreignAmount: 0, exchangeRate: 30 };
            if (type === 'asset') setAssets(prev => [...prev, ni]);
            else setLiabilities(prev => [...prev, ni]);
          };

          const saveSnapshot = () => {
            const today = new Date().toISOString().split('T')[0]; 
            const currentMonth = today.substring(0, 7); 
            const existingIndex = records.findIndex(r => r.date.substring(0, 7) === currentMonth);
            const newRecord = { id: Date.now(), date: today, totalAssets, totalLiabilities, netWorth, assetsDetail: assets, liabilitiesDetail: liabilities };
            let newRecords = [...records];
            if (existingIndex !== -1) {
              if (confirm(`本月已有紀錄，是否更新？`)) { newRecords[existingIndex] = newRecord; showToast('數據已更新'); } 
              else return;
            } else {
              newRecords = [...newRecords, newRecord].sort((a, b) => new Date(a.date) - new Date(b.date));
              showToast('新快照已建立');
            }
            setRecords(newRecords); forceSave(assets, liabilities, newRecords); 
          };

          const formatCurrency = (num) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(num);
          const formatNumber = (num) => new Intl.NumberFormat('en-US').format(num);
          const chartData = useMemo(() => records.map(r => ({ date: r.date, 淨資產: r.netWorth, 總資產: r.totalAssets, 總負債: r.totalLiabilities })), [records]);
          const assetPieData = useMemo(() => {
            const g = {}; assets.forEach(i => { const c = i.category || 'other'; g[c] = (g[c] || 0) + Number(i.amount); });
            return Object.keys(g).map(k => ({ name: CATEGORY_MAP[k] || '其他', value: g[k] })).filter(i => i.value > 0);
          }, [assets]);

          const renderCustomizedLabel = ({ cx, cy, midAngle, innerRadius, outerRadius, percent, index, name }) => {
            const RADIAN = Math.PI / 180;
            const radius = innerRadius + (outerRadius - innerRadius) * 2.2;
            const x = cx + radius * Math.cos(-midAngle * RADIAN);
            const y = cy + radius * Math.sin(-midAngle * RADIAN);
            if (percent < 0.05) return null;
            return <text x={x} y={y} fill={COLORS[index % COLORS.length]} textAnchor={x > cx ? 'start' : 'end'} dominantBaseline="central" fontSize="11" fontWeight="bold">{`${name} ${(percent * 100).toFixed(0)}%`}</text>;
          };

          if (loading && !assets.length) {
            return <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 text-slate-500"><Loader2 className="animate-spin mb-4 text-indigo-500" size={48} /><p className="font-bold">安全連線中...</p></div>;
          }

          return (
            <div className="min-h-screen bg-gray-50 text-gray-800 font-sans pb-24 relative selection:bg-indigo-100 no-scrollbar">
              {/* Toast */}
              <div className={`fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-slate-800/90 backdrop-blur text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-2 transition-all duration-300 z-[60] text-sm ${toast.show ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4 pointer-events-none'}`}>
                {toast.type === 'success' ? <Check size={16} className="text-emerald-400" /> : <AlertTriangle size={16} className="text-red-400" />}
                {toast.message}
              </div>

              {/* Account Modal (純密碼) */}
              {accountModal.isOpen && (
                <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[70] flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-white rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden">
                        <div className="bg-slate-900 p-8 text-white text-center relative">
                            <button onClick={() => setAccountModal({isOpen: false})} className="absolute top-4 right-4 text-slate-400 hover:text-white"><X size={20}/></button>
                            <Lock size={48} className="mx-auto mb-4 text-indigo-400" />
                            <h3 className="text-xl font-bold">同步密碼鎖</h3>
                            <p className="text-xs text-slate-400 mt-2 leading-relaxed">輸入同一組密碼，即可在不同手機/電腦同步您的財富數據。</p>
                        </div>
                        <div className="p-6 space-y-6">
                            <div className="relative">
                                 <Key size={18} className="absolute left-3 top-4 text-slate-400" />
                                 <input 
                                    type="password" 
                                    value={inputKey} 
                                    onChange={(e) => setInputKey(e.target.value)} 
                                    className="w-full pl-10 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-200 text-center tracking-[0.5em] text-lg" 
                                    placeholder="輸入自訂密碼" 
                                 />
                            </div>
                            <button onClick={handleAuth} disabled={authLoading} className="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                                {authLoading ? <Loader2 className="animate-spin" /> : <Check size={18} />}
                                確認並同步數據
                            </button>
                        </div>
                    </div>
                </div>
              )}

              {/* Delete Modal */}
              {deleteModal.isOpen && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl p-6 max-w-xs w-full">
                        <h3 className="text-lg font-bold text-center mb-6">確定要刪除嗎？</h3>
                        <div className="flex gap-3">
                            <button onClick={() => setDeleteModal({ ...deleteModal, isOpen: false })} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold">取消</button>
                            <button onClick={confirmDelete} className="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold">刪除</button>
                        </div>
                    </div>
                </div>
              )}

              <header className="bg-slate-900 text-white px-4 py-3 shadow-md sticky top-0 z-40 flex justify-between items-center safe-top">
                  <div className="flex items-center gap-2">
                    <div className="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center shadow-lg"><LayoutDashboard size={18} className="text-white" /></div>
                    <div><h1 className="text-base font-bold leading-none">財富總管</h1><span className="text-[10px] text-slate-400 font-mono">{activeKey ? '加密同步中' : '訪客模式'}</span></div>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-800 text-xs">
                        {syncStatus === 'saving' && <RefreshCw size={14} className="text-yellow-400 animate-spin"/>}
                        {syncStatus === 'saved' && <Check size={14} className="text-emerald-400"/>}
                        {syncStatus === 'idle' && <Cloud size={14} className="text-slate-400"/>}
                        {syncStatus === 'error' && <CloudOff size={14} className="text-red-400"/>}
                    </div>
                    <button onClick={() => setAccountModal({ isOpen: true })} className={`w-8 h-8 rounded-full flex items-center justify-center transition-all active:scale-95 ${activeKey ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>
                        {activeKey ? <ShieldCheck size={16} /> : <Lock size={16} />}
                    </button>
                  </div>
              </header>

              <main className="max-w-md mx-auto p-4 space-y-6">
                {activeTab === 'dashboard' && (
                  <div className="space-y-6 animate-fade-in pb-4">
                     <div className="bg-gradient-to-br from-indigo-600 to-indigo-800 p-6 rounded-3xl shadow-xl shadow-indigo-200 text-white relative overflow-hidden transition-all">
                        <div className="absolute -right-4 -top-4 opacity-10"><DollarSign size={120} /></div>
                        <div className="relative z-10">
                            <span className="text-indigo-200 text-sm font-medium">目前淨資產</span>
                            <div className="text-4xl font-bold mt-1 tracking-tight">{formatCurrency(netWorth)}</div>
                            <div className="mt-4 flex gap-4">
                                <div><span className="text-indigo-200 text-xs block font-bold">總資產</span><span className="text-emerald-300 font-bold text-lg">{formatNumber(totalAssets)}</span></div>
                                <div className="w-px bg-indigo-500/50"></div>
                                <div><span className="text-indigo-200 text-xs block font-bold">總負債</span><span className="text-rose-300 font-bold text-lg">{formatNumber(totalLiabilities)}</span></div>
                            </div>
                        </div>
                     </div>
                     <div className="space-y-6">
                        {assetPieData.length > 0 ? (
                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                                <h3 className="text-base font-bold text-slate-800 mb-4 flex items-center gap-2"><div className="w-6 h-6 rounded-md bg-emerald-100 flex items-center justify-center text-emerald-600"><PieIcon size={14} /></div>資產配置</h3>
                                <div className="h-64 w-full -ml-2">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie data={assetPieData} cx="50%" cy="50%" innerRadius={50} outerRadius={70} paddingAngle={5} dataKey="value" label={renderCustomizedLabel} labelLine={true}>
                                                {assetPieData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}
                                            </Pie>
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        ) : <div className="bg-white p-6 rounded-3xl shadow-sm border border-dashed border-slate-300 text-center py-10"><p className="text-slate-400 text-sm font-bold italic">尚無資產數據</p></div>}
                        {records.length >= 2 && (
                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                                <h3 className="text-base font-bold text-slate-800 mb-4 flex items-center gap-2"><div className="w-6 h-6 rounded-md bg-indigo-100 flex items-center justify-center text-indigo-600"><TrendingUp size={14} /></div>資產趨勢</h3>
                                <div className="h-56 w-full -ml-4">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={chartData}>
                                            <defs><linearGradient id="colorNet" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#6366f1" stopOpacity={0.8}/><stop offset="95%" stopColor="#6366f1" stopOpacity={0}/></linearGradient></defs>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                            <XAxis dataKey="date" tick={{fontSize: 10, fill: '#94a3b8'}} axisLine={false} tickLine={false} />
                                            <YAxis tickFormatter={(val) => `${(val/10000).toFixed(0)}w`} tick={{fontSize: 10, fill: '#94a3b8'}} width={35} axisLine={false} tickLine={false} />
                                            <RechartsTooltip formatter={(value) => formatCurrency(value)} contentStyle={{borderRadius: '12px', border: 'none'}} />
                                            <Area type="monotone" dataKey="淨資產" stroke="#6366f1" strokeWidth={3} fillOpacity={1} fill="url(#colorNet)" />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        )}
                     </div>
                  </div>
                )}

                {activeTab === 'input' && (
                  <div className="space-y-4 animate-fade-in pb-20">
                    {!activeKey && (
                        <div className="bg-amber-50 border border-amber-200 p-4 rounded-2xl text-sm text-amber-800 flex items-start gap-3">
                          <AlertTriangle size={20} className="shrink-0 text-amber-600" />
                          <div><strong>重要：建議設定同步密碼</strong><p className="mt-1">點擊右上角鎖頭設定密碼，數據才能安全備份至雲端，並在不同裝置間同步。</p></div>
                        </div>
                    )}
                    <div>
                        <div className="flex justify-between items-center mb-3 px-1">
                          <h3 className="font-bold text-emerald-800 flex items-center gap-2"><Wallet size={18} className="text-emerald-600"/> 資產</h3>
                          <button onClick={() => addItem('asset')} className="text-xs bg-emerald-100 text-emerald-700 px-3 py-1.5 rounded-full hover:bg-emerald-200 flex items-center gap-1 font-bold active:scale-95 transition shadow-sm border border-emerald-100"><Plus size={14} /> 新增</button>
                        </div>
                        <div className="space-y-3">
                          {assets.map((item) => (
                            <div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition">
                                <div className="flex justify-between items-center mb-2">
                                    <select value={item.category} onChange={(e) => setAssets(prev => prev.map(p => p.id === item.id ? {...p, category: e.target.value} : p))} className="text-xs bg-slate-100 border-none rounded-lg py-1 px-2 text-slate-600 font-bold outline-none">
                                        <option value="invest">股票/投資</option><option value="cash">現金/存款</option><option value="real_estate">房地產</option><option value="other">其他</option>
                                    </select>
                                    <button onClick={() => openDeleteModal('asset', item.id, item.name)} className="text-slate-300 p-1 hover:text-red-500 transition active:scale-90"><Trash2 size={16} /></button>
                                </div>
                                <input type="text" value={item.name} onChange={(e) => handleAssetChange(item.id, 'name', e.target.value)} className="w-full text-base font-bold text-slate-800 border-none p-0 mb-3 focus:ring-0" placeholder="項目名稱" />
                                <div className="bg-slate-50 rounded-xl p-3 border border-slate-100">
                                    {item.isForeign ? (
                                        <div className="space-y-2">
                                            <div className="flex items-center gap-2"><span className="text-[10px] font-bold text-slate-400 w-6">外幣</span><input type="number" value={item.foreignAmount || ''} onChange={(e) => handleAssetChange(item.id, 'foreignAmount', e.target.value)} className="flex-1 bg-white rounded-lg px-2 py-1.5 text-sm outline-none border border-slate-200 focus:border-indigo-400" /></div>
                                            <div className="flex items-center gap-2"><span className="text-[10px] font-bold text-slate-400 w-6">匯率</span><input type="number" value={item.exchangeRate || ''} onChange={(e) => handleAssetChange(item.id, 'exchangeRate', e.target.value)} className="flex-1 bg-white rounded-lg px-2 py-1.5 text-sm outline-none border border-slate-200 focus:border-indigo-400" /></div>
                                            <div className="border-t border-slate-200 pt-2 flex justify-between items-center"><span className="text-[10px] text-slate-400 font-bold">換算台幣</span><span className="text-emerald-600 font-bold">{formatNumber(item.amount)}</span></div>
                                        </div>
                                    ) : (
                                        <div className="flex items-center"><span className="text-sm font-bold text-slate-400 mr-2">TWD</span><input type="text" inputMode="decimal" value={item.amount === 0 ? '' : formatNumber(item.amount)} onChange={(e) => { const val = e.target.value.replace(/,/g, ''); if (!isNaN(val) && /^\d*$/.test(val)) handleAssetChange(item.id, 'amount', val === '' ? 0 : Number(val)); }} className="w-full text-xl font-bold text-right bg-transparent border-none p-0 text-slate-700 focus:ring-0" /></div>
                                    )}
                                </div>
                                <div className="mt-2 flex justify-end"><label className="flex items-center gap-1.5 text-xs text-slate-500 font-bold cursor-pointer"><input type="checkbox" checked={item.isForeign || false} onChange={(e) => handleAssetChange(item.id, 'isForeign', e.target.checked)} className="rounded text-indigo-600 w-4 h-4 cursor-pointer" /> 外幣計算</label></div>
                            </div>
                          ))}
                        </div>
                    </div>
                    <div className="mt-8">
                        <div className="flex justify-between items-center mb-3 px-1">
                          <h3 className="font-bold text-rose-800 flex items-center gap-2"><CreditCard size={18} className="text-rose-600"/> 負債</h3>
                          <button onClick={() => addItem('liability')} className="text-xs bg-rose-100 text-rose-700 px-3 py-1.5 rounded-full hover:bg-rose-200 flex items-center gap-1 font-bold shadow-sm border border-rose-100 active:scale-95 transition"><Plus size={14} /> 新增</button>
                        </div>
                        <div className="space-y-3">
                          {liabilities.map((item) => (
                            <div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition">
                                <div className="flex justify-between items-center mb-2">
                                     <select value={item.category} onChange={(e) => setLiabilities(prev => prev.map(p => p.id === item.id ? {...p, category: e.target.value} : p))} className="text-xs bg-slate-100 border-none rounded-lg py-1 px-2 text-slate-600 font-bold outline-none">
                                        <option value="mortgage">房貸</option><option value="credit">信貸</option><option value="loan">借貸</option><option value="other">其他</option>
                                    </select>
                                    <button onClick={() => openDeleteModal('liability', item.id, item.name)} className="text-slate-300 p-1 hover:text-red-500 transition active:scale-90"><Trash2 size={16} /></button>
                                </div>
                                <input type="text" value={item.name} onChange={(e) => setLiabilities(prev => prev.map(p => p.id === item.id ? {...p, name: e.target.value} : p))} className="w-full text-base font-bold text-slate-800 border-none p-0 mb-3 focus:ring-0" placeholder="項目名稱" />
                                <div className="bg-slate-50 rounded-xl p-3 border border-slate-100 flex items-center">
                                    <span className="text-sm font-bold text-slate-400 mr-2">$</span>
                                    <input type="text" inputMode="decimal" value={item.amount === 0 ? '' : formatNumber(item.amount)} onChange={(e) => { const val = e.target.value.replace(/,/g, ''); if (!isNaN(val) && /^\d*$/.test(val)) handleLiabilityChange(item.id, val === '' ? 0 : Number(val)); }} className="w-full text-xl font-bold text-right bg-transparent border-none p-0 text-slate-700 focus:ring-0" />
                                </div>
                            </div>
                          ))}
                        </div>
                    </div>
                    <div className="fixed bottom-20 left-0 w-full px-4 z-30">
                      <button onClick={saveSnapshot} className="w-full bg-slate-900 text-white font-bold py-3.5 rounded-2xl shadow-2xl active:scale-95 transition-all"><Save size={18} /> 紀錄本月財報</button>
                    </div>
                  </div>
                )}

                {activeTab === 'history' && (
                  <div className="space-y-4 animate-fade-in pb-4">
                     {records.length === 0 ? <div className="p-12 text-center text-slate-400 font-bold"><History size={48} className="mx-auto mb-4 opacity-20" /> 尚無歷史紀錄</div> : 
                       <div className="space-y-3">{records.slice().reverse().map((record) => (
                           <div key={record.id} className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col gap-3 hover:shadow-md transition">
                             <div className="flex justify-between items-start border-b border-slate-50 pb-2">
                                <div><span className="text-xs text-slate-400 font-bold block">紀錄日期</span><span className="text-slate-800 font-bold">{record.date}</span></div>
                                <button onClick={() => openDeleteModal('record', record.id, `${record.date} 的紀錄`)} className="text-slate-300 p-1 hover:text-red-500 transition active:scale-95"><Trash2 size={16} /></button>
                             </div>
                             <div className="grid grid-cols-3 gap-2 text-center">
                                <div><span className="text-[10px] text-emerald-500 block mb-1 font-bold">總資產</span><span className="text-sm font-bold text-slate-700">{formatNumber(record.totalAssets)}</span></div>
                                <div><span className="text-[10px] text-rose-500 block mb-1 font-bold">總負債</span><span className="text-sm font-bold text-slate-700">{formatNumber(record.totalLiabilities)}</span></div>
                                <div><span className="text-[10px] text-indigo-500 block mb-1 font-bold">淨資產</span><span className="text-sm font-bold text-slate-900">{formatNumber(record.netWorth)}</span></div>
                             </div>
                           </div>
                         ))}</div>
                     }
                  </div>
                )}
              </main>

              <nav className="fixed bottom-0 left-0 w-full bg-white border-t border-slate-100 pb-safe z-50">
                <div className="flex justify-around items-center h-16 max-w-md mx-auto">
                    <button onClick={() => setActiveTab('dashboard')} className={`flex-1 flex flex-col items-center justify-center gap-1 h-full active:scale-90 transition-transform ${activeTab === 'dashboard' ? 'text-indigo-600' : 'text-slate-400'}`}><LayoutDashboard size={24} strokeWidth={activeTab === 'dashboard' ? 2.5 : 2} /><span className="text-[10px] font-bold">總覽</span></button>
                    <button onClick={() => setActiveTab('input')} className={`flex-1 flex flex-col items-center justify-center gap-1 h-full active:scale-90 transition-transform ${activeTab === 'input' ? 'text-indigo-600' : 'text-slate-400'}`}><div className={`w-12 h-12 rounded-full flex items-center justify-center mb-3 shadow-lg ${activeTab === 'input' ? 'bg-indigo-600 text-white shadow-indigo-200' : 'bg-slate-900 text-white'}`}><Plus size={24} /></div></button>
                    <button onClick={() => setActiveTab('history')} className={`flex-1 flex flex-col items-center justify-center gap-1 h-full active:scale-90 transition-transform ${activeTab === 'history' ? 'text-indigo-600' : 'text-slate-400'}`}><History size={24} strokeWidth={activeTab === 'history' ? 2.5 : 2} /><span className="text-[10px] font-bold">紀錄</span></button>
                </div>
              </nav>
            </div>
          );
        };
        
        const root = createRoot(document.getElementById('root'));
        root.render(<WealthManager />);
    </script>
</body>
</html>